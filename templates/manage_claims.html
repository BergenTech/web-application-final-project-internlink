{% extends 'base.html' %}
{% block title %}Manage Claims{% endblock %}

{% block content %}
<div class="w3-container w3-content" style="max-width: 1000px; margin-top: 80px;">
    <h2>Manage Claims</h2>
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
        <div class="flashed-messages">
            {% for category, message in messages %}
                <div class="alert alert-{{ category }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}
    {% endwith %}
    <table id="claimsTable" class="w3-table w3-bordered w3-striped w3-card-4">
        <thead>
            <tr>
                <th>Intern</th>
                <th>Organization</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for claim in claims %}
            <tr>
                <td>{{ claim.intern.intern_name }}</td>
                <td>{{ claim.organization.company_name }}</td>
                <td>
                    <span class="badge 
                        {% if claim.status == 'Approved' %} badge-success
                        {% elif claim.status == 'Denied' %} badge-danger
                        {% elif claim.status == 'Pending' %} badge-warning
                        {% endif %}">
                        {{ claim.status }}
                    </span>
                </td>
                <td>

                    <form action="{{ url_for('approve_claim', intern_id=claim.intern_id, organization_id=claim.organization_id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="w3-button w3-green">Approve</button>
                    </form>
                    <form action="{{ url_for('deny_claim', intern_id=claim.intern_id, organization_id=claim.organization_id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="w3-button w3-red">Deny</button>
                    </form>
                    </form>
                    <form action="{{ url_for('pending_claim', intern_id=claim.intern_id, organization_id=claim.organization_id) }}" method="POST" style="display:inline;">
                        <button type="submit" class="w3-button w3-orange">Pending</button>
                    </form>

                </td>
            </tr>
            {% endfor %}
        </tbody>
        <tfoot>
            <tr>
                <th>Intern</th>
                <th>Organization</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </tfoot>
    </table>
</div>

<!-- Include DataTables CSS and JS -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.11.3/css/jquery.dataTables.css">
<script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-3.5.1.js"></script>
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.11.3/js/jquery.dataTables.js"></script>

<script>
$(document).ready(function() {
    // Initialize DataTable
    var table = $('#claimsTable').DataTable({
        orderCellsTop: true,
        fixedHeader: true
    });

    // Add unique dropdowns for each column filter in the footer
    $('#claimsTable tfoot th').each(function(i) {
        var title = $(this).text();
        if (title != "Actions") { // Skip adding dropdown to "Actions" column
            var select = $('<select class="filter-select"><option value="">All</option></select>')
                .appendTo($(this).empty())
                .on('change', function() {
                    var val = $.fn.dataTable.util.escapeRegex($(this).val());
                    table.column(i).search(val ? '^' + val + '$' : '', true, false).draw();
                });
            table.column(i).data().unique().sort().each(function(d, j) {
                d = $('<div/>').html(d).text().trim(); // Clean the data
                select.append('<option value="' + d + '">' + d + '</option>')
            });
        }
    });

    // Move the footer filter row to the header for better UI
    $('#claimsTable tfoot tr').appendTo('#claimsTable thead');
});
</script>



<style>
    .badge-success {
        background-color: #28a745;
        color: white;
    }

    .badge-danger {
        background-color: #dc3545;
        color: white;
    }

    .badge-warning {
        background-color: #ffc107;
        color: black;
    }

    .filter-select {
        width: 100%;
        box-sizing: border-box;
    }
</style>
{% endblock %}
